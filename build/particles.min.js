function Create_Text_Image(t,e,i,r){var o=document.createElement("canvas");o.width=t,o.height=e;var n=o.getContext("2d");return r&&(n.fillStyle=r,n.fillRect(0,0,e,t)),n.font="Bold 20px Serif",n.fillStyle="rgba(255,255,255,1)",n.fillText(i,4,e/2),o}function my_draw_image(t,e,i,r,o){var n=t.getContext("2d");n.fillStyle=o||"#000000",n.fillRect(0,0,t.width,t.height),n.drawImage(e,0,0)}function get_old_lib(t){void 0!==typeof _&&(t.old=_)}function Event_Hub(){this.events={}}function test(){var t=new Custom_Emitter;t.set_emit_function("p.position.z = -100; p.velocity.y = 100;");var e={velocity:{x:0,y:0,z:0},position:{x:0,y:0,z:0}};t.custom_func(e),console.log(e);var i=t.toJSON();console.log(i),(t=new Custom_Emitter).parse(i.params)}function test_chain_loader(){var t=new My_Lib.Chain_Loader;t.item_loaded=function(t){console.log("load item ",t)},t.finished=function(t){console.log("loader manager - job done")},t.load_func=function(t,e,i,r){t?e(t):i(t)},t.start(["first","second",null,"tree"])}function Star_Dust_Emitter(){My_Lib.Particle_Emitter.apply(this,arguments),this.start_position=new THREE.Vector3(0,0,0),this.end_position=new THREE.Vector3(1,1,1),this.delta=new THREE.Vector3(1,1,1),this.velocity=new THREE.Vector3(0,0,1)}function Star_Dust_Affector(t){this.end=t||0}function init(){var t={};t.load_resources=function(t){this.resource_list=["textures/particle2.png","textures/particle1.png","textures/Particle4.jpg","textures/spark.png"];var e=["json/cone_particles1.json","json/cone_particles2.json","json/star_dust.json"];My_Lib.Texture_Manager.load_list_textures(this.resource_list,function(){My_Lib.Texture_Manager.load_list_json(e,function(){t()})})},t.create_sun=function(){function t(t){var e=My_Lib.Texture_Manager.get(t),i=My_Lib.particle_manager.fromJSON(e,function(){},a.main_scene,t);a.main_scene.add(i.node),a.add_animated_object(i)}var e=new THREE.PointLight(16776960);e.position.set(10,300,200),this.main_scene.add(e);var i=new THREE.SphereGeometry(7,20,20),r=new THREE.MeshBasicMaterial({color:16750848}),o=new THREE.Mesh(i,r);o.name="sun",o.position.z=-100,this.main_scene.add(o),this.main_camera.lookAt(o.position),this.main_camera.position.z=10;var n=new My_Lib.Euler_Controller(o,0,60,0);this.add_animated_object(n);var a=this,s=new THREE.Object3D;s.position.set(0,0,0),this.main_scene.add(s);a=this;t("json/cone_particles1.json"),t("json/cone_particles2.json"),t("json/star_dust.json")},t.init_ui=function(){this.control_panel=new Control_Panel,this.control_panel.add_particles(My_Lib.particle_manager.get_particle_names()),this.control_panel.set_textures(this.resource_list)},t.created=function(){console.log("created");var t=this;this.load_resources(function(){t.create_sun(),t.init_ui(),t.loop()})},(new(Application.extend(t))).start()}var texture_format_to_string;!function(){var t=[];texture_format_to_string=function(e){var i=t[e];return void 0===i&&console.error("Fuck! texture format is undefined "+e),i},ttt=t,ttt[1021]="alpha",ttt[1022]="rgb",ttt[1023]="RGBE",ttt[1023]="rgba",ttt[1024]="luminance",ttt[1025]="luminance alpha",ttt[1026]="Depth",ttt[1027]="Depth Stencil"}();var new_lib={},_=new_lib;!function(t){t.copy_object=function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t.create_clone_object=function(e){var i={};return t.copy_object(i,e),i},t.copy_field_list=function(t,e,i){for(var r,o=0;o<i.length;o++)e[r=i[o]]=t[r]},t.create_clone_field_list=function(t,e){for(var i,r={},o=0;o<e.length;o++)r[i=e[o]]=t[i];return r},t.clone_field_list_one_level_recursion=function(e,i,r){for(var o,n=0;n<r.length;n++)i[o=r[n]]="object"==typeof o?t.create_clone_object(e[o]):e[o]},t.every_property=function(t,e){if(e)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e(i);else console.log("callback given every_property is undefined or null!")}}(_);var My_Lib={};My_Lib.Viewport={},THREE.Vector3.prototype.applyMatrix4_rotation=function(t){var e=this.x,i=this.y,r=this.z,o=t.elements;return this.x=o[0]*e+o[4]*i+o[8]*r,this.y=o[1]*e+o[5]*i+o[9]*r,this.z=o[2]*e+o[6]*i+o[10]*r,this},My_Lib.Object_Animation=function(t,e){this.object=t,this.animation=e},My_Lib.Object_Animation.prototype.update=function(t){this.animation(this.object,t)},My_Lib.create_text_image=function(t,e,i,r,o){var n=document.createElement("canvas");n.width=t,n.height=e;var a=n.getContext("2d");o&&(a.fillStyle=o,a.fillRect(0,0,n.width,n.height)),a.font="Bold 40px Arial",a.fillStyle="rgba(0,255,0,0.95)",a.fillText("Hello, world!",0,50);var s=new THREE.Texture(n);return r&&(s.wrapS=s.wrapT=THREE.TextureWrapping.ClampToEdgeWrapping,s.minFilter=THREE.LinearFilter),s.needsUpdate=!0,s},My_Lib.Grid=function(t,e,i,r,o,n){this.xsegments=i,this.ysegments=r;var a=t/i,s=e/r,c=t/-2+a/2,_=e/-2+s/2,l=n;n||(l=new THREE.MeshBasicMaterial({opacity:1,transparent:!0,depthWrite:!0,depthTest:!1,map:o})),this.material=l;var p;this.segments=new Array,this.root=new THREE.Object3D;for(var h=new Array(8),u=1/i,m=1/r,d=0;d<r;d++)for(var f=0;f<i;f++){p=new THREE.PlaneBufferGeometry(a,s);var y=new THREE.Mesh(p,l);y.position.x=c+f*a,y.position.y=_+d*s,y._row=f,y._col=d,this.segments.push(y),this.root.add(y),y._pos=new THREE.Vector3(y.position);var v=1-m*d-m;h[0]=u*f,h[1]=v,h[2]=u*f+u,h[3]=v,h[4]=u*f,h[5]=v+m,h[6]=u*f+u,h[7]=v+m,p.attributes.uv.array=new Float32Array(h)}},My_Lib.Grid.prototype.update=function(t){this.animation&&this.animation_live&&this.update_animation(t)},My_Lib.Grid.prototype.start_animation=function(){if(this.animation){if(!this.animation_live){for(var t=0;t<this.segments.length;t++)this.animation.start(this.segments[t]);this.animation_live=!0}}else console.log("Grid Error! Trying start animaton, but animation undefined!")},My_Lib.Grid.prototype.update_animation=function(t){for(var e=!1,i=0;i<this.segments.length;i++){var r=this.segments[i];r._wait>0?(r._wait-=t,e=!0):(this.animation.run(t,r),e||(e=r._is_live))}this.animation_live=e,this.animation_live||this.animation.done()},My_Lib.Rotate_Animation=function(t,e){this.wait=t,this.animation_speed=e,this.rotation_axis=[0,0,1],this.end_rotation_value=2*Math.PI},My_Lib.Rotate_Animation.prototype.done=function(){this.onAnimationEnding&&this.onAnimationEnding()},My_Lib.Rotate_Animation.prototype.start=function(t){t._wait=Math.random()*this.wait,this.col_waiting&&(t._wait+=this.col_waiting*t._col),this.row_waiting&&(t._wait+=this.row_waiting*t._row),t._is_live=!0,t._mrotate=0,this.swap_dir?t._dir=100*Math.random()-50>0?1:-1:t._dir=1,this.live=!0},My_Lib.Rotate_Animation.prototype.run=function(t,e){e._is_live&&(e._mrotate+=this.animation_speed*t*e._dir,Math.abs(e._mrotate)>=this.end_rotation_value&&(e._mrotate=this.end_rotation_value,e._is_live=!1)),e.rotation.x=e._mrotate*this.rotation_axis[0],e.rotation.y=e._mrotate*this.rotation_axis[1],e.rotation.z=e._mrotate*this.rotation_axis[2]},My_Lib.Create_Quad=function(t,e,i,r){var o=new THREE.PlaneBufferGeometry(t,e),n=new THREE.ShaderMaterial({vertexShader:i,fragmentShader:r}),a=new THREE.Mesh(o,n);return a.rotation.y=Math.PI,a},My_Lib.Render_Target=function(t,e){this.target=new THREE.WebGLRenderTarget(t,e,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBFormat}),this.camera=new THREE.PerspectiveCamera(80,t/e,.1,1e3)},My_Lib.Render_Target.prototype.render=function(t,e){e.render(t,this.camera,this.target,!0)},My_Lib.create_overlay_camera=function(t,e){return new THREE.OrthographicCamera(t/-2,t/2,e/2,e/-2,-1e4,1e4)},My_Lib.Overlay=function(t,e){this.camera=My_Lib.create_overlay_camera(t,e)},My_Lib.Overlay.prototype.render=function(t){this.scene&&(t.autoClear=!1,t.render(this.scene,this.camera),t.autoClear=!0)},My_Lib.mouse_coords_to_vector=function(t,e){var i=t.getBoundingClientRect(),r=t.clientWidth,o=t.clientHeight,n=(e.clientX-i.left)/r*2-1,a=-((e.clientY-i.top)/o*2-1);return new THREE.Vector3(n,a,1)},My_Lib.mouse_coords_to_ray=function(t,e,i){var r=t.getBoundingClientRect(),o=t.clientWidth,n=t.clientHeight,a=(e.clientX-r.left)/o*2-1,s=-((e.clientY-r.top)/n*2-1),c=new THREE.Vector3(a,s,1);return c.unproject(i),new THREE.Raycaster(i.position,c.sub(i.position).normalize())},My_Lib.find_intersection_with_mouse_vector=function(t,e,i){return t.unproject(e),new THREE.Raycaster(e.position,t.sub(e.position).normalize()).intersectObjects([i],!0)},My_Lib.Mouse_Controller=function(t,e,i,r){this.root=t,this.over=e,this.click=!!i,this.callback=r},My_Lib.event_hub=new Event_Hub,Event_Hub.prototype.add_event_listener=function(t,e,i){this.events[t]||(this.events[t]=[]),this.events[t].push({name:t,func:e,obj:i})},Event_Hub.prototype.on=Event_Hub.prototype.add_event_listener,Event_Hub.prototype.emit=function(t,e){var i=this.events[t];if(i)for(var r=0;r<i.length;r++){var o=i[r];o.func.call(o.obj,e)}};var run_function=function(t){window.setTimeout(t,1e3/60)};My_Lib.create_run_function=function(t){My_Lib.run=function(){run_function(function(){t.loop()})}},My_Lib.Euler_Controller=function(t,e,i,r){this.obj=t,this.xspeed=e*Math.PI/180,this.yspeed=i*Math.PI/180,this.zspeed=r*Math.PI/180},My_Lib.Euler_Controller.prototype.update=function(t){this.obj.rotation.x+=this.xspeed*t,this.obj.rotation.y+=this.yspeed*t,this.obj.rotation.z+=this.zspeed*t},My_Lib.Registered_Classes={},My_Lib.Register_Class=function(t,e){My_Lib.Registered_Classes[t]&&console.log("Register Class ERROR! Class with this name already exists!",t),My_Lib.Registered_Classes[t]=e},My_Lib.Get_Class=function(t){return My_Lib.Registered_Classes[t]},My_Lib.create_class=function(t,e,i,r){t&&(e.prototype=Object.create(t.prototype)),_.copy_object(e.prototype,i),e.prototype.contructor=e,My_Lib.Register_Class(e,r)},My_Lib.every_property=function(t,e){if(e)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e(i);else console.log("callback given every_property is undefined or null!")},Application=function(t){this._lifecycle_event("before_created"),this._init_timer(),this._create_loop_function(),this.mouse_controllers=[],My_Lib.event_hub.add_event_listener("kill_me",function(t){this.remove_animated_object(t)},this)},Application.prototype.start=function(t){this._set_configuration(t)},Application.prototype._lifecycle_event=function(t){return!this[t]||this[t]()},Application.prototype._init_timer=function(){this.clock=new THREE.Clock,this.delta_time=0,this.animated_objects=[]},Application.prototype._create_loop_function=function(){var t=this;this.run=function(){run_function(function(){t.loop()})}},Application.prototype.get_default_configuration=function(){return{dom_element:"screen",render_params:{premultipliedAlpha:!0,alpha:!0},viewport:{width:800,height:600},clear_color:255,main_camera:{fov:80,near:.1,far:1e3,aspect_ratio:1.3333333333333333,position:{x:0,y:0,z:0}}}},Application.prototype._create_render=function(t){this.renderer=new THREE.WebGLRenderer(t.render_params),this.dom_screen=document.getElementById(t.dom_element),this.dom_screen&&void 0!==this.dom_screen||console.error("Some terrorous happens! dom element for screen not found! element id is "+t.dom_element),console.log("found dome element "+t.dom_element,this.dom_screen),this.dom_screen.appendChild(this.renderer.domElement),this.renderer.setSize(t.viewport.width,t.viewport.height),this.set_viewport(t.viewport.width,t.viewport.height),this.renderer.setClearColor(t.clear_color),this._lifecycle_event("render_created")},Application.prototype._create_main_scene=function(t){if(this._lifecycle_event("before_create_main_scene")){this.main_scene||(this.main_scene=new THREE.Scene);var e=t.main_camera;this.main_camera?(this.main_camera.fov=e.fov,this.main_camera.near=e.near,this.main_camera.far=e.far,this.main_camera.aspect=e.aspect_ratio,this.main_camera.updateProjectionMatrix()):(this.main_camera=new THREE.PerspectiveCamera(e.fov,e.aspect_ratio,e.near,e.far),this.main_scene.add(this.main_camera)),this.main_camera.position.set(e.position.x,e.position.y,e.position.z)}},Application.prototype.apply_configuration=function(t){this.configuration=t,this._create_render(t),this._create_main_scene(t),this._lifecycle_event("created")},Application.prototype.load_configuration=function(t){var e=new THREE.XHRLoader,i=this,r=i.get_default_configuration();e.load(t,function(e){console.log("configuration loaded from url"+t);var o=JSON.parse(e);_.copy_object(r,o),i.apply_configuration(r)},function(){},function(t){console.error("Error on loading config!",t),console.log("Setting default configuration"),i.apply_configuration(r)})},Application.prototype._set_configuration=function(t){"string"==typeof t?console.log("get configuration from url"):"object"==typeof t?(console.log("get configuration from user object"),this.apply_configuration(t)):(console.log("get default configration"),this.apply_configuration(this.get_default_configuration()))},Application.extend=function(t,e){var i;return i=void 0===e?function(){console.log("exec child constructor"),Application.apply(this,arguments)}:e,console.log("create child"),i.prototype=Object.create(Application.prototype),_.copy_object(i.prototype,t),i.prototype.constructor=i,i},Application.extend_proto=function(t,e){var i=Object.create(t);return _.copy_object(i,e),Application.call(i),i},Application.prototype.loop=function(){var t=this.clock.getDelta();t>.1&&(t=.1),this.delta_time=t,this.update(t),this.render(t),this.run()},Application.prototype.add_animated_object=function(t){this.animated_objects.push(t)},Application.prototype.remove_animated_object=function(t){for(var e=0;e<this.animated_objects.length;e++)if(this.animated_objects[e]===t){this.animated_objects.splice(e,1);break}},Application.prototype.update_all=function(t){for(var e,i=0,r=this.animated_objects.length;i<r;i++)(e=this.animated_objects[i]).update&&e.update(t)},Application.prototype.update=function(t){this.update_all(t)},Application.prototype.create_mouse_move_listener=function(){if(!this.mouse_move_listener){var t=this;this.mouse_move_listener=!0,document.addEventListener("mousemove",function(e){var i=My_Lib.mouse_coords_to_vector(t.dom_screen,e);t.find_mouse_over_intersections(i)})}},Application.prototype.find_mouse_over_intersections=function(t){t.unproject(this.main_camera);for(var e,i=new THREE.Raycaster(this.main_camera.position,t.sub(this.main_camera.position).normalize()),r=0,o=this.mouse_controllers.length;r<o;r++)if((e=this.mouse_controllers[r]).over){var n=i.intersectObjects([e.root],!0);e.callback(n)}},Application.prototype.add_mouse_controller=function(t,e,i,r){var o=new My_Lib.Mouse_Controller(t,e,i,r);return this.mouse_controllers.push(o),e&&this.create_mouse_move_listener(),o},Application.prototype.set_viewport=function(t,e){My_Lib.Viewport.width=t,My_Lib.Viewport.height=e},Application.prototype.render=function(t){this.renderer.setClearColor(this.configuration.clear_color),this.renderer.autoClear=!0,this.renderer.render(this.main_scene,this.main_camera)},Custom_Affector=function(){My_Lib.Particle_Affector.apply(this,arguments),this.custom_func=function(){return!0}},My_Lib.create_class(My_Lib.Particle_Affector,Custom_Affector,{affect:function(t,e,i){return this.custom_func(t,p,i)},test_func:function(){var t={position:{x:0,y:0,z:0},velocity:{x:0,y:0,z:0}},e={r:0,g:0,b:0};this.custom_func(t,e)},set_affect_function:function(t){if("function"==typeof t)this.custom_func=t;else if("string"==typeof t){try{this.custom_func=new Function("dt,p,vert",t),this.test_func()}catch(t){alert(t),this.custom_func=void 0}this.source_code=t}},toJSON:function(){var t={name:"Custom_Affector"};return t.params=My_Lib.Particle_Affector.prototype.toJSON.call(this,this),params.source_code=this.source_code,t},parse:function(t){My_Lib.Particle_Affector.prototype.parse(this,t),this.set_affect_func(t.source_code)}},"Custom_Affector"),Custom_Emitter=function(){My_Lib.Particle_Emitter.apply(this,arguments)},My_Lib.create_class(My_Lib.Particle_Emitter,Custom_Emitter,{emit:function(t,e){this.custom_func&&this.custom_func(t,e)},test_func:function(){var t={position:{x:0,y:0,z:0},velocity:{x:0,y:0,z:0}},e={r:0,g:0,b:0};this.custom_func(t,e)},set_emit_function:function(t){if("function"==typeof t)this.custom_func=t;else if("string"==typeof t){try{this.custom_func=new Function("p","color",t),this.test_func()}catch(t){alert(t),this.custom_func=void 0}this.source_code=t}},toJSON:function(){var t={};return t.name="Custom_Emitter",t.params=My_Lib.Particle_Emitter.prototype.toJSON.call(this,this),this.source_code&&(t.params.source_code=this.source_code),t},parse:function(t){My_Lib.Particle_Emitter.prototype.parse.call(this,t),this.set_emit_function(t.source_code)}},"Custom_Emitter");var Custom_Func_Mixin={test_func:function(){var t={position:{x:0,y:0,z:0},velocity:{x:0,y:0,z:0}},e={r:0,g:0,b:0};this.custom_func(t,e)},set_emit_function:function(t,e){if("function"==typeof t)this.custom_func=t;else if("string"==typeof t){try{this.custom_func=new Function(e,t),this.test_func()}catch(t){alert(t),this.custom_func=void 0}this.source_code=t}}},Particle_Forces={};Particle_Forces.Force=function(){},_.copy_object(Particle_Forces.Force.prototype,{calc:function(t,e,i){},toJSON:function(t){return{}},parse:function(t){}}),Particle_Forces.Constant_Force=function(t){this.force=void 0!==t?t:{x:0,y:0,z:0}},Particle_Forces.Constant_Force.prototype=Object.create(Particle_Forces.Force.prototype),_.copy_object(Particle_Forces.Constant_Force.prototype,{constructor:Particle_Forces.Constant_Force,calc:function(t,e,i){i.x+=this.force.x,i.y+=this.force.y,i.z+=this.force.z},toJSON:function(t){var e={};return e.name="Constant_Force",e.force=My_Lib.create_clone_object(this.force),e},parse:function(t){t.force&&_.copy_object(this.force,t.force)}}),My_Lib.Register_Class("Constant_Force",Particle_Forces.Constant_Force);var Point_Generators={};Point_Generators.Random_Direction=function(){},Point_Generators.Random_Direction.prototype.get_direction=function(t){t.x=Math.random(),t.y=Math.random(),t.z=Math.random()},Point_Generators.Sphere=function(t){this.radius=t},Point_Generators.Sphere.prototype.get_inner_point=function(t){var e=Math.random()*Math.PI*2,i=Math.random()*Math.PI;t.x=Math.cos(e)*Math.sin(i),t.y=Math.cos(i),t.z=Math.sin(e)*Math.sin(i)},Point_Generators.Sphere.prototype.get_normal=function(t){t.x=2*Math.random()-1,t.y=2*Math.random()-1,t.z=2*Math.random()-1,t.normalize()},Point_Generators.Sphere.prototype.get_point=function(t){this.get_normal(t),t.multiplyScalar(this.radius)},My_Lib.Chain_Loader=function(){},My_Lib.Chain_Loader.prototype={constructor:My_Lib.Chain_Loader,start:function(t){this.list=t,this.index=0,this.load(this.list[0]),this.stop_by_error=!1},next:function(t){this.item_loaded&&t&&this.item_loaded(t,this.list[this.index]),++this.index<this.list.length?this.load(this.list[this.index]):this.finished&&this.finished()},do_error:function(t){this.onerror?this.onerror(t):console.error("Error!",t),this.stop_by_error||this.next()},do_progress:function(){this.onprogress&&this.onprogress.apply(this,arguments)},load:function(t){var e=this;this.load_func&&this.load_func(t,function(t){e.next.apply(e,arguments)},function(t){e.do_error.apply(e,arguments)},function(t){e.do_progress.apply(e,arguments)})}},My_Lib.Loading_Manager=function(){this.resources={},this.texture_loader=new THREE.TextureLoader},My_Lib.Loading_Manager.prototype={constructor:My_Lib.Loading_Manager,get:function(t){return this.resources[t]},get_async:function(t,e){var i=this.get(t);if(i)return e&&e(i),i;return i=this.texture_loader.load(t,function(t){e&&e(t)}),this.resources[t]=i,i},load_list:function(t,e,i,r){var o=this,n=new My_Lib.Chain_Loader,o=this;n.onerror=function(t){console.error("ERROR loading texture",t,n.list[n.index])},n.item_loaded=function(t,e){o.resources[e]=t,o.on_resource_loaded&&o.on_resource_loaded(t)},n.on_progress=function(){r&&r()},n.load_func=function(){i.apply(this,arguments)},n.finished=function(){e&&e()},n.start(t)},load_list_textures:function(t,e){var i=this;this.load_list(t,e,function(t,e,r,o){i.texture_loader.load(t,e,o,r)})},load_list_json:function(t,e,i){var r=new THREE.XHRLoader;this.load_list(t,e,function(t,e,i,o){r.load(t,e,o,i)},i)},free:function(){this.resources={}}},My_Lib.Texture_Manager=new My_Lib.Loading_Manager,My_Lib.Particle_Affector=function(){},My_Lib.Particle_Affector.prototype.affect=function(t,e,i,r){return!0},My_Lib.Particle_Affector.prototype.toJSON=function(t){if(t)return{};var e={name:"Particle_Affector",params:{}};return t?params:e},My_Lib.Particle_Affector.prototype.parse=function(t){},My_Lib.Force_Affector=function(){this.forces=new Array},My_Lib.Force_Affector.prototype=Object.create(My_Lib.Particle_Affector.prototype),_.copy_object(My_Lib.Force_Affector.prototype,{constructor:My_Lib.Force_Affector,add_force:function(t){this.forces.push(t)},apply_forces:function(t,e,i,r){for(var o={x:0,y:0,z:0},n=0;n<this.forces.length;n++)this.forces[n].calc(t,e,o);e.velocity.x+=o.x*t,e.velocity.y+=o.y*t,e.velocity.z+=o.z*t},affect:function(t,e,i,r){return this.apply_forces(t,e,i,r),!0},toJSON:function(t){var e={};if(e.name="Force_Affector",e.params=My_Lib.Particle_Affector.prototype.toJSON.call(this,this),this.forces.length>0){e.params.forces=new Array;for(var i=0;i<this.forces.length;i++)e.params.forces.push(this.forces[i].toJSON())}return e},parse:function(t){var e,i;if(t.forces)for(var r=0;r<t.forces.length;r++)i=t.forces[r],(e=My_Lib.Get_Class(i.name))&&((e=new e).parse(i),this.add_force(e))}}),My_Lib.Register_Class("Force_Affector",My_Lib.Force_Affector),My_Lib.Particle_Emitter=function(t){this.emit_delta=0,this.emit_count=0,this.emit_per_second=t||10,this.lifetime={min:0,max:1}},My_Lib.Particle_Emitter.prototype.emit_life=function(){return this.lifetime.min+Math.random()*(this.lifetime.max-this.lifetime.min)},My_Lib.Particle_Emitter.prototype.calc_emitted_particles=function(t){this.emit_delta+=this.emit_per_second*t;var e=Math.floor(this.emit_delta);return e>0&&(this.emit_delta-=e),e},My_Lib.Particle_Emitter.prototype.set_parent_object=function(t,e){"string"==typeof t?e&&(this.parent=e.getObjectByName(t)):this.parent=t},My_Lib.Particle_Emitter.prototype.emit=function(t){},My_Lib.Particle_Emitter.prototype.toJSON=function(t){var e={emit_per_second:this.emit_per_second,lifetime:{min:this.lifetime.min,max:this.lifetime.max}};if(this.parent&&("string"==typeof this.parent?e.parent=this.parent:e.parent=this.parent.name),t)return e;var i={};return i.name="Particle_Emitter",i.params=e,i},My_Lib.Particle_Emitter.prototype.parse=function(t){this.emit_per_second=t.emit_per_second,_.copy_object(this.lifetime,t.lifetime)},My_Lib.Register_Class("Particle_Emitter",My_Lib.Particle_Emitter),My_Lib.Particle_System=function(t){this.emitter=t.emitter,this.emitter||(this.emitter=new My_Lib.Particle_Emitter(1)),this.affector=t.affector,this.affector||(this.affector=new My_Lib.Particle_Affector),this.particle_lifetime=t.particle_lifetime||3,this.params=t,this.texture=t.texture,this.no_fade_color=t.no_fade_color=!!t.no_fade_color,void 0===this.params.pre_alpha&&(this.params.pre_alpha=!0),void 0===this.params.depth_test&&(this.params.depth_test=!0),void 0===this.params.depth_write&&(this.params.depth_write=!1),t.color||(t.color={r:1,g:1,b:1}),t.blending||(t.blending="one_alpha"),this.dynamic_color=t.end_color||t.random_color,t.size=t.size||1;var e=t.count||100;this.material=this.create_particle_material(),this.node=new THREE.Points(this.create_particle_geometry(e),this.material)},My_Lib.Particle_System.prototype.suicide=function(){this.node.parent.remove(this.node),My_Lib.event_hub.emit("kill_me",this)},My_Lib.Particle_System.prototype.create=function(t,e){},My_Lib.Particle_System.prototype.create_particle_geometry=function(t){this.particle_data=new Array(t);for(var e,i=new Float32Array(3*t),r=new Float32Array(3*t),o=new Float32Array(t),n=0;n<t;n++)(e={}).position=new THREE.Vector3(0,0,0),e.velocity=new THREE.Vector3(0,0,0),this.particle_data[n]=e,e.lifetime=0,i[3*n]=0,i[3*n+1]=0,i[3*n+2]=0,o[n]=0,r[3*n]=this.params.color.r,r[3*n+1]=this.params.color.g,r[3*n+2]=this.params.color.b;this.geometry={},this.geometry.vertices=new THREE.BufferAttribute(i,3).setDynamic(!0),this.geometry.colors=new THREE.BufferAttribute(r,3),this.dynamic_color&&this.geometry.colors.setDynamic(!0),this.geometry.params=new THREE.BufferAttribute(o,1).setDynamic(!0);var a=new THREE.BufferGeometry;return this.geometry.buffer=a,a.addAttribute("position",this.geometry.vertices),a.addAttribute("color",this.geometry.colors),a.addAttribute("params",this.geometry.params),a},My_Lib.Particle_System.prototype.generate_material_name=function(){var t="MY_PARTICLE_MATERIAL";return this.texture&&(t+="_WITH_TEXTURE"),this.no_fade_color&&(t+="_NO_FADE_COLOR"),t},My_Lib.Particle_System.prototype.blending_mode={additive:{blendSrc:THREE.OneFactor,blendDst:THREE.OneFactor},alpha:{blendSrc:THREE.SrcAlphaFactor,blendDst:THREE.OneMinusSrcAlphaFactor},one_alpha:{blendSrc:THREE.OneFactor,blendDst:THREE.OneMinusSrcAlphaFactor},alpha_one:{blendSrc:THREE.SrcAlphaFactor,blendDst:THREE.OneFactor}},My_Lib.Particle_System.prototype.convert_blending_mode=function(t){var e,i=this.blending_mode.one_alpha;return"no"===t?e=THREE.NoBlending:(e=THREE.CustomBlending,this.blending_mode[t]&&(i=this.blending_mode[t])),{blending:e,factors:i}},My_Lib.Particle_System.prototype.set_texture=function(t){if("string"==typeof t){if(this.params.texture===t)return;this.params.texture=t,this.texture=My_Lib.Texture_Manager.get(t)}else console.error("Oh Shit! texture in set_texture is not string! it's object or undefined!",t);this.material.uniforms.sprite?this.material.uniforms.sprite.value=this.texture:console.error("Oh Shit! Our shader has not texture! Need create shader with texture!")},My_Lib.Particle_System.prototype.create_uniforms=function(){var t={sprite:{value:this.texture},lifetime:{value:this.particle_lifetime},point_size:{value:this.params.size},screen_size:{value:new THREE.Vector2(My_Lib.Viewport.width,My_Lib.Viewport.height)}};return this.dynamic_color||(t.particle_color={value:this.params.color}),t},My_Lib.Particle_System.prototype.calc_defines=function(){var t={};return this.params.pre_alpha&&(t.PRE_ALPHA=!0),this.texture&&(t.PARTICLE_TEXTURE=!0),this.no_fade_color&&(t.NO_FADE_COLOR=!0),t},My_Lib.Particle_System.prototype.create_particle_material=function(){"string"==typeof this.texture&&(this.texture=My_Lib.Texture_Manager.get(this.texture));var t=THREE.CustomBlending,e=this.blending_mode.one_alpha,i=this.params.blending;i&&("no"===i?t=THREE.NoBlending:this.blending_mode[i]&&(e=this.blending_mode[i]));var r=this.create_uniforms(),o=this.calc_defines();return new THREE.ShaderMaterial({transparent:!0,depthWrite:this.params.depth_write,depthTest:this.params.depth_test,blending:t,blendSrc:e.blendSrc,blendDst:e.blendDst,defines:o,uniforms:r,vertexShader:Particle_Shaders.vertex,fragmentShader:Particle_Shaders.fragment})},My_Lib.Particle_System.prototype.set_pre_alpha=function(t){this.params.pre_alpha!==!!t&&(this.params.pre_alpha=t,console.log("a"),this.node.material=this.material=this.create_particle_material())},My_Lib.Particle_System.prototype.set_point_size=function(t){this.params.size!=t&&(this.params.size=t,this.node.material.uniforms.point_size.value=t)},My_Lib.Particle_System.prototype.set_blending=function(t){this.params.blending=t;var e=this.convert_blending_mode(t);this.material.blending=e.blending,this.material.blendSrc=e.factors.blendSrc,this.material.blendDst=e.factors.blendDst},My_Lib.Particle_System.prototype.emit_particles=function(t,e){for(var i,r=this.geometry.vertices.array,o=this.geometry.params.array,n=0;n<this.particle_data.length&&e>0;n++)o[n]>0||(i=this.particle_data[n],this.emitter.emit(i),i.lifetime=this.particle_lifetime,r[3*n]=i.position.x,r[3*n+1]=i.position.y,r[3*n+2]=i.position.z,o[n]=i.lifetime,e--)},My_Lib.Particle_System.prototype.update_particle_geometry=function(t){for(var e,i=this.geometry.vertices.array,r=this.geometry.params.array,o=new THREE.Vector3(0,0,0),n={r:1,b:1,g:1},a=0;a<this.particle_data.length;a++)r[a]>0&&((e=this.particle_data[a]).position.x+=e.velocity.x*t,e.position.y+=e.velocity.y*t,e.position.z+=e.velocity.z*t,e.lifetime-=t,(e.lifetime<=0||!this.affector.affect(t,e,o,n))&&(e.lifetime=0),r[a]=e.lifetime,i[3*a]=e.position.x,i[3*a+1]=e.position.y,i[3*a+2]=e.position.z);var s=this.emitter.calc_emitted_particles(t);this.emit_particles(t,s),this.geometry.vertices.needsUpdate=!0,this.geometry.params.needsUpdate=!0},My_Lib.Particle_System.prototype.update=function(t){this.update_particle_geometry(t)},My_Lib.Particle_System.prototype.toJSON=function(){var t={};return t.name="test",t.params={},this.params&&_.copy_object(t.params,this.params),t.params.emitter=this.emitter.toJSON(),t.params.affector=this.affector.toJSON(),t},My_Lib.Particle_System.prototype.set_emitter=function(t){this.emitter=this.params.emitter=t},My_Lib.Particle_System.prototype.set_particle_life_length=function(t){t!==this.params.particle_lifetime&&(this.params.particle_lifetime=this.particle_lifetime=t,this.material.uniforms.lifetime.value=t)},My_Lib.Particle_System.prototype.set_emission_per_second=function(t){this.emitter.emit_per_second=t},My_Lib.Particle_System.prototype.set_particle_count=function(t){t!==this.particle_data.length&&(this.params.count=t,this.node.geometry=this.create_particle_geometry(t))},My_Lib.Particle_System.prototype.set_color=function(t){this.params.color.r=t.r,this.params.color.g=t.g,this.params.color.b=t.b},My_Lib.Particle_Manager_Class=function(){this.particles={}},My_Lib.Particle_Manager_Class.prototype.fromJSON=function(t,e,i,r){this.particles[r]&&console.log("WARNING Particle Manager! Particle System with this name already exists",r);try{var o=JSON.parse(t)}catch(e){throw console.log("error parsing json on ",r,t),e}if(o.params.emitter){var n=My_Lib.Get_Class(o.params.emitter.name);(n=n?new n:new My_Lib.Particle_Emitter).parse(o.params.emitter.params),o.params.emitter.params.parent&&n.set_parent_object(o.params.emitter.params.parent,i),o.params.emitter=n}if(o.params.affector){var a=My_Lib.Get_Class(o.params.affector.name);(a=a?new a:new My_Lib.Particle_Affector).parse(o.params.affector.params),o.params.affector=a}var s=new My_Lib.Particle_System(o.params);return My_Lib.Texture_Manager.get_async(o.params.texture,e),e&&e(s),this.particles[r]=s,s},My_Lib.Particle_Manager_Class.prototype.load_scene=function(t,e,i){var r=[];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&r.push({key:t[o]});var n=new My_Lib.Chain_Loader,a=this;n.item_loaded=function(t,e){a.particles[e]=t},n.finished=function(){e&&e()},n.load_func=function(t,e){a.fromJSON(t,function(){e()},i,n.list[n.index])}},My_Lib.Particle_Manager_Class.prototype.get_particle_names=function(){var t=[];for(var e in this.particles)t.push(e);return t},My_Lib.Particle_Manager_Class.prototype.remove_particles=function(t){var e=this.particles[t];e&&(e.suicide(),delete this.particles[t])},My_Lib.particle_manager=new My_Lib.Particle_Manager_Class,My_Lib.Particles_Config={box_size:10};var Particle_Shaders={};!function(){var t=["attribute vec4 color;","attribute float params;","varying vec4 vcolor;","uniform float lifetime;","uniform float point_size;","uniform vec2 screen_size;","#ifndef DYNAMIC_COLORS","uniform vec3 particle_color;","#endif","void main () {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","#ifdef DYNAMIC_COLORS","vcolor.rgb = color.rgb;","#else","vcolor.rgb = particle_color.rgb;","#endif","#ifdef NO_FADE_COLOR","vcolor.a = 1.0;","#else","float tmp = params / lifetime;","tmp = min(tmp, 1.0);","vcolor.a = tmp;","#endif","float t =  screen_size.y* projectionMatrix[1][1] / gl_Position.w;","t = t * point_size;","if (params > 0.0) {","gl_PointSize = t;","}","else {","gl_PointSize = 0.0;","}","}"],e=["varying vec4 vcolor;","#ifdef PARTICLE_TEXTURE","uniform sampler2D sprite;","#endif","void main() {","#ifdef PARTICLE_TEXTURE","vec4 tex = texture2D( sprite, gl_PointCoord );","vec3 fragment_color = tex.rgb;","fragment_color.rgb *= vcolor.rgb;","float alpha = tex.a;","#else","vec3 fragment_color = vcolor.rgb;","float alpha = 1.0;","#endif","#ifdef PRE_ALPHA","fragment_color.rgb *= alpha;","#endif","#ifndef NO_FADE_COLOR","float fragment_alpha = alpha * vcolor.a;","#else","float fragment_alpha = alpha;","#endif","gl_FragColor = vec4(fragment_color.rgb, fragment_alpha);","}"];Particle_Shaders.vertex=t.join("\n"),Particle_Shaders.fragment=e.join("\n")}();var Cone_Emitter=function(){My_Lib.Particle_Emitter.apply(this,arguments),this.generator=new Point_Generators.Random_Direction,this.origin=new THREE.Vector3(1,1,0),this.velocity=new THREE.Vector3(0,1,0),this.dispersion={min:5,max:10},this.dispersion.delta=5,this.speed={min:5,max:10,delta:5},this.color=new THREE.Color(1,1,1)};Cone_Emitter.prototype=Object.create(My_Lib.Particle_Emitter.prototype),Cone_Emitter.prototype.constructor=Cone_Emitter,My_Lib.Register_Class("Cone_Emitter",Cone_Emitter),Cone_Emitter.prototype.toJSON=function(){var t={};return t.name="Cone_Emitter",t.params=My_Lib.Particle_Emitter.prototype.toJSON.call(this,this),My_Lib.clone_field_list_one_level_recursion(this,t.params,["origin","velocity","dispersion","speed"]),t},Cone_Emitter.prototype.parse=function(t){My_Lib.Particle_Emitter.prototype.parse.call(this,t),this.origin.copy(t.origin),this.velocity.copy(t.velocity),this.set_dispersion(t.dispersion.min,t.dispersion.max),this.set_speed(t.speed.min,t.speed.max)},Cone_Emitter.prototype.set_speed=function(t,e){this.speed.min=t,this.speed.max=e,this.speed.delta=e-t},Cone_Emitter.prototype.set_dispersion=function(t,e){this.dispersion.min=t,this.dispersion.max=e,this.dispersion.delta=e-t},Cone_Emitter.prototype.emit=function(t,e){t.position.copy(this.origin),this.generator.get_direction(t.velocity),t.velocity.multiplyScalar(Math.random()*this.dispersion.delta+this.dispersion.min),t.velocity.add(this.velocity).normalize(),this.parent&&(this.parent.localToWorld(t.position),t.velocity.applyMatrix4_rotation(this.parent.matrixWorld)),t.velocity.multiplyScalar(Math.random()*this.speed.delta+this.speed.min),e&&this.emit_color(e)},Cone_Emitter.prototype.emit_color=function(t){t.copy(this.color)},Sphere_Emitter=function(t){My_Lib.Particle_Emitter.call(this),this.radius=t,this.generator=new Point_Generators.Sphere(t)},Sphere_Emitter.prototype=Object.create(My_Lib.Particle_Emitter.prototype),Sphere_Emitter.prototype.constructor=My_Lib.Sphere_Emitter,Sphere_Emitter.prototype.emit=function(t){this.generator.get_point(t.position),this.generator.get_normal(t.velocity),t.velocity.multiplyScalar(10)},Star_Dust_Emitter.prototype=Object.create(My_Lib.Particle_Emitter.prototype),Star_Dust_Emitter.prototype.constructor=Star_Dust_Emitter,_.copy_object(Star_Dust_Emitter.prototype,{set_velocity:function(t,e,i){this.velocity.set(t,e,i)},set_position_range:function(t,e){this.start_position.copy(t),this.end_position.copy(e),this.delta.set(e.x-t.x,e.y-t.y,e.z-t.z)},get_position:function(t){t.x=Math.random()*this.delta.x+this.start_position.x,t.y=Math.random()*this.delta.y+this.start_position.y,t.z=Math.random()*this.delta.z+this.start_position.z},get_velocity:function(t){t.x=this.velocity.x,t.y=this.velocity.y,t.z=this.velocity.z},emit:function(t){this.get_position(t.position),this.parent&&this.parent.localToWorld(t.position),this.get_velocity(t.velocity)},toJSON:function(){var t=My_Lib.Particle_Emitter.prototype.toJSON.call(this,this);return My_Lib.clone_field_list_one_level_recursion(this,t,["velocity","start_position","end_position"]),{name:"Star_Dust_Emitter",params:t}},parse:function(t){My_Lib.Particle_Emitter.prototype.parse.call(this,t),this.set_position_range(t.start_position,t.end_position),this.velocity.copy(t.velocity)}}),My_Lib.Register_Class("Star_Dust_Emitter",Star_Dust_Emitter),Star_Dust_Affector.prototype=Object.create(My_Lib.Particle_Affector.prototype),Star_Dust_Affector.prototype.constructor=Star_Dust_Affector,_.copy_object(Star_Dust_Affector.prototype,{affect:function(t,e,i){return!(e.position.z>this.end)},toJSON:function(){var t=My_Lib.Particle_Affector.prototype.toJSON.call(this,this);return t.end=this.end,{name:"Star_Dust_Affector",params:t}},parse:function(t){My_Lib.Particle_Affector.prototype.parse(this,t),this.end=t.end}}),My_Lib.Register_Class("Star_Dust_Affector",Star_Dust_Affector);var editor={};editor.create_vue_app=function(t){return new Vue({el:t,data:{particles:[],textures:[]},template:'<div id="app">            <particles-panel :particles="particles" :textures="textures"></particles-panel>            </div>'})},editor.Color_Picker={props:{value:{type:Object,default:function(){return{r:0,g:0,b:0}}}},template:'<div>    <p>Red Green Blue Color    <p>    <input type="range" min="0" max="255" @change="changed" :value="value.r" ref="r" id="r" >    <input type="range" min="0" max="255" @change="changed" :value="value.g" ref="g" id="g">    <input type="range" min="0" max="255" @change="changed" :value="value.b" ref="b" id="b">    </div>',data:function(){return{new_value:{r:0,g:0,b:0}}},methods:{changed:function(t){this.value[t.target.id]=t.target.value,this.$emit("input",this.value)}}},Vue.component("color-picker",editor.Color_Picker),editor.Particles_Panel={props:{particles:{type:Object,default:function(){return[]}},textures:{type:Object,default:function(){return[]}},selected:{type:String,default:""}},data:function(){return{particle_params:{},my_selected:!1}},methods:{add_particles:function(){},remove_particles:function(t){event_hub.$emit("remove_particles",this.my_selected);for(var e=0;e<this.particles.length;e++)if(this.particles[e]==this.my_selected){this.particles.splice(e,1),this.particles.length>0?e+1<this.particles.length?this.my_selected=this.particles[e+1]:this.my_selected=this.particles[0]:this.my_selected="";break}},change_colors:function(t){event_hub.$emit("change_particles_color",this.my_selected,t)},select_particles:function(t){this.particle_params=event_hub.get_particle_params(this.my_selected)},play:function(t){event_hub.$emit("replay",this.my_selected,this.particle_params)}},created:function(){this.selected?this.my_selected=this.selected:this.particles.length>0&&(this.my_selected=this.particles[0]),this.my_selected&&(this.particle_params=event_hub.get_particle_params(this.my_selected))},watch:{particles:function(t){this.particles.length>0&&(this.my_selected=this.particles[0])},my_selected:function(t){this.particle_params=event_hub.get_particle_params(this.my_selected)}},template:'<div>\t<button type="button" id="btn-add" v-on:click="add_particles">Add</button>\t<br>\t<select v-model="my_selected" id="object-list">\t\t<option disabled value="">Please select one</option>\t  <option v-for="option in particles" v-bind:value="option">\t\t{{ option }}\t  </option>\t</select>\t<br>\t<span>Selected: {{ my_selected }}</span>    <p>Particles properties</p>    <div v-if="my_selected">        <ParticlesProps  :params="particle_params" />        <button type="button" id="btn-play" v-on:click="play">Refresh</button>        <button type="button" id="btn-remove" v-on:click="remove_particles">Remove</button><texture-panel :textures=textures :particle_id=my_selected :selected=particle_params.texture></texture-panel>    </div>    </div>'},Vue.component("particles-panel",editor.Particles_Panel),editor.Blending_Selector={props:{blending:{type:String,required:!0,default:"no"}},template:'<select v-model="blending" id="blending" v-on:change="select">            <option value="no">no</option>            <option value="additive">additive</option>            <option value="one_alpha">one, minus src alpha</option>            <option value="alpha_one">minus src alpha, one</option>            <option value="alpha">alpha</option>        </select>',methods:{select:function(t){this.$emit("change",this.blending)}}},editor.Behavior={props:["affect_method","emit_method"],data:function(){return{behavior:!1}},template:'<div>    <button type="button" @click="show_behavior">Show Behaviour</button>    <div class="behavior" v-if="behavior">    <p>affect method<br>    <textarea v-model="affect_method"></textarea>    <p>emit method<br>    <textarea v-model="emit_method"></textarea>    </div>',methods:{show_behavior:function(t){var e=!this.behavior;this.behavior=e}}},editor.Particle_Params={props:{params:{type:Object,default:function(){return{}}}},template:'<div @keyup.13="fire">        <div class="prop-column">            Life Length: <br/>            <input type="text" id="life_length" v-model.number="params.life_length" type="number" step="0.1" />        </div>        <div class="prop-column">            Emit per second <br/>            <input type="text" id="emit_per_second" v-model.number="params.emit_per_second" type="number" />        </div>        <div class="prop-column">            Number of particles<br/>            <input type="text" id="count" v-model.number="params.count" type="number" />        </div>        <div class="prop-column">            Point Size<br/>            <input type="text" id="size" v-model.number="params.size" type="number" step="0.1" />        </div></div>',methods:{fire:function(t){this.$parent.fire(t)}}},editor.Particles_Props={props:{params:{type:Object,default:function(){return{}}}},template:'<div>  <particle-params :params=params />        <color-picker :value="params.color" @input="update_color"></color-picker>        <p>Blending mode</p>            <blending-mode :blending=params.blending @change="blending_change"> </blending-mode>        <p>Precomputed alpha <input type="checkbox" v-model="params.precomputed_alpha" @change="fire" id="pre_alpha"></p>        <behavior :affect_method=params.affect_method :emit_method=params.emit_method />    <div>',data:function(){return{behavior:!1}},watch:{params:function(){console.log("change ",this.params.id)}},methods:{blending_change:function(t){this.params.blending=t,this.emit_param_change("blending",t)},emit_param_change:function(t,e){var i={};i[t]=e,event_hub.$emit("change_params",this.params.id,i)},fire:function(t){var e="checkbox"===t.target.type?t.target.checked:t.target.value;this.emit_param_change(t.target.id,e)},update_color:function(t){event_hub.$emit("change_color",this.params.id,t)}},components:{"blending-mode":editor.Blending_Selector,behavior:editor.Behavior,"particle-params":editor.Particle_Params}},Vue.component("ParticlesProps",editor.Particles_Props),editor.Texture_Panel={template:'<div class="texture-panel">            <select id="texture_select" :value="selected" v-on:change="choose_texture">            <option v-for="option in textures" v-bind:value="option">                {{ option }}            </option>            </select>            <button type="button" v-on:click="apply">apply</button>            <br>            <div class="texture-canvas">            <canvas id="texture-canvas-obj" class="texture-canvas" ref="canvas">            </canvas>            </div>            <div class="texture-info">                Texture Format  {{format}} <br />                Texture Width {{texture_width}} Height {{texture_height}}            </div>        </div>',props:["textures","selected","particle_id"],data:function(){return{selected_texture:"",texture_width:0,texture_height:0,format:""}},methods:{choose_texture:function(t){this.selected=t.target.value,this.selected_texture=this.selected,this.draw_texture(this.selected)},apply:function(){event_hub.$emit("select_texture",this.particle_id,this.selected_texture)},draw_texture:function(t){if(t){var e=event_hub.get_texture(t);if(e){this.format=texture_format_to_string(e.format);var i=e.image;this.texture_width=i.naturalWidth||i.width,this.texture_height=i.naturalHeight||i.height,my_draw_image(this.$refs.canvas,i,0,0)}else console.error("Oh, Fuck! Texture "+t+" not found!")}},get_texture_from_particles:function(t){t&&(this.selected_texture=event_hub.get_texture_from_particles(t),this.draw_texture(this.selected_texture))}},watch:{particle_id:function(t){this.get_texture_from_particles(t)}},mounted:function(){this.get_texture_from_particles(this.particle_id)}},Vue.component("texture-panel",editor.Texture_Panel),init();var event_hub,Control_Panel=(Control_Panel=function(){this.create_event_hub(),this.app=this.create_vue_app(),event_hub.$on("remove_particles",this.remove_particles.bind(this)),event_hub.$on("replay",this.replay_params.bind(this)),event_hub.$on("change_color",this.change_particles_color.bind(this)),event_hub.$on("change_params",this.change_some_params.bind(this)),event_hub.$on("select_texture",this.set_texture.bind(this))},Control_Panel.prototype.create_event_hub=function(){var t={get_texture:function(t){var e=My_Lib.Texture_Manager.get(t);return e||console.error("Unfound texture with id "+t),e},get_texture_from_particles:function(t){var e=My_Lib.particle_manager.particles[t];selected_texture="";{if(e)return selected_texture=e.params.texture,selected_texture;console.error("oh shit! particles "+value+" not existed! function get_texture_from_particles")}},get_particle_params:function(t){var e=My_Lib.particle_manager.particles[t];if(!e)return console.error("ERROR! particles "+this.selected+"not found!"),{};var i=e.params.color;return{id:t,texture:e.params.texture,count:e.params.count,size:e.params.size,emit_per_second:e.emitter.emit_per_second,life_length:e.particle_lifetime,color:{r:255*i.r,g:255*i.g,b:255*i.b},blending:e.params.blending,precomputed_alpha:e.params.pre_alpha,emit_method:e.params.emitter.source_code?e.params.emitter.source_code.slice(0):"",affect_method:e.params.affector.source_code?e.params.emitter.source_code.slice(0):""}}};event_hub=new Vue({methods:t})},Control_Panel.prototype.set_texture=function(t,e){My_Lib.particle_manager.particles[t].set_texture(e)},Control_Panel.prototype.remove_particles=function(t){My_Lib.particle_manager.remove_particles(t)},Control_Panel.prototype.change_particles_color=function(t,e){My_Lib.particle_manager.particles[t].set_color({r:e.r/255,g:e.g/255,b:e.b/255})},Control_Panel.prototype.change_some_params=function(t,e){var i,r=My_Lib.particle_manager.particles[t];void 0!==e.life_length&&(i=parseFloat(e.life_length),r.set_particle_life_length(i)),void 0!==e.emit_per_second&&r.set_emission_per_second(e.emit_per_second),void 0!==e.count&&r.set_particle_count(e.count),void 0!==e.size&&r.set_point_size(e.size),void 0!==e.blending&&r.set_blending(e.blending),void 0!==e.pre_alpha&&r.set_pre_alpha(!!e.pre_alpha)},Control_Panel.prototype.replay_params=function(t,e){var i=My_Lib.particle_manager.particles[t];if(!i)throw"ERROR! not found particles with id "+t;if(e.emit_method){var r=i.params.emitter;r.source_code||(r=new Custom_Emitter,i.set_emitter(r)),r.set_emit_function(this.particle_params.emit_method)}i.set_particle_life_length(e.life_length),i.set_emission_per_second(e.emit_per_second),i.set_particle_count(e.count),this.change_particles_color(t,e.color),i.set_blending(e.blending),i.set_pre_alpha(e.precomputed_alpha);var o=e.size;if("string"==typeof o){var n=o.replace(",",".");o=parseFloat(n)}i.set_point_size(o)},Control_Panel.prototype.add_particles=function(t){for(var e in My_Lib.particle_manager.particles)this.app.particles.push(e)},Control_Panel.prototype.set_textures=function(t){for(var e=0;e<t.length;e++)this.app.textures.push(t[e])},Control_Panel.prototype.create_vue_app=function(){return editor.create_vue_app("#app")},Control_Panel);